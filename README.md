# ENCOS SDK

ENCOS电机CAN通信协议开发SDK，提供完整的电机控制接口和原型开发指导。

## 项目描述

本项目基于CAN总线通信协议，提供了与ENCOS电机进行通信和控制的完整解决方案。包含底层CAN通信、协议编码解码、电机控制API以及用户交互界面等完整功能模块。

## CAN通信协议开发指南

### 1. 基础CAN通信参数

与电机建立CAN总线通信需要配置以下参数：

- **波特率**: 1M
- **标识符类型**: 标准标识符 (0x01 到 0x7FF)
- **数据长度**: 4 到 8 字节
- **通信模式**:
  - **问答模式 (默认)**: 电机仅在接收到命令后发送反馈消息
  - **自动消息模式**: 电机持续发送状态消息

**重要说明:**
- 标识符 `0x7FF` 专门用于电机设置和查询命令
- 其他标准范围内的标识符作为电机的特定ID用于控制命令
- 建议购买兼容的USB-to-CAN分析仪进行调试

### 2. 电机设置和配置命令

这些命令使用标识符 `0x7FF`，用于电机的初始设置和配置。配置命令之间应有至少500ms的延迟。

#### 2.1 设置电机零点位置

将电机当前位置校准为零点。

- **标识符**: `0x7FF`
- **主机命令帧 (4字节)**:
  | 字节0 | 字节1 | 字节2 | 字节3 |
  |-------|-------|-------|-------|
  | 电机ID高字节 | 电机ID低字节 | `0x00` | `0x03` |

- **电机响应帧 (4字节)**:
  - **成功**:
    | 字节0 | 字节1 | 字节2 | 字节3 |
    |-------|-------|-------|-------|
    | 电机ID高字节 | 电机ID低字节 | `0x01` | `0x03` |
  
  - **失败**:
    | 字节0 | 字节1 | 字节2 | 字节3 |
    |-------|-------|-------|-------|
    | 电机ID高字节 | 电机ID低字节 | `0x01` | `0x00` |

#### 2.2 设置电机CAN通信ID

为电机分配新的CAN ID。

- **标识符**: `0x7FF`
- **主机命令帧 (6字节)**:
  | 字节0 | 字节1 | 字节2 | 字节3 | 字节4 | 字节5 |
  |-------|-------|-------|-------|-------|-------|
  | 旧ID高字节 | 旧ID低字节 | `0x00` | `0x04` | 新ID高字节 | 新ID低字节 |

#### 2.3 重置电机CAN通信ID

全局命令，将任何连接的电机ID重置为默认值 `0x01`。

- **标识符**: `0x7FF`
- **主机命令帧 (6字节)**:
  | 字节0 | 字节1 | 字节2 | 字节3 | 字节4 | 字节5 |
  |-------|-------|-------|-------|-------|-------|
  | `0x7F` | `0x7F` | `0x00` | `0x05` | `0x7F` | `0x7F` |

### 3. 电机查询命令

#### 3.1 查询通信模式

- **标识符**: `0x7FF`
- **主机命令帧 (4字节)**:
  | 字节0 | 字节1 | 字节2 | 字节3 |
  |-------|-------|-------|-------|
  | 电机ID高字节 | 电机ID低字节 | `0x00` | `0x81` |

#### 3.2 查询CAN通信ID

用于发现连接到总线的电机ID。

- **标识符**: `0x7FF`
- **主机命令帧 (4字节)**:
  | 字节0 | 字节1 | 字节2 | 字节3 |
  |-------|-------|-------|-------|
  | `0xFF` | `0xFF` | `0x00` | `0x82` |

### 4. 电机控制命令

这些命令直接控制电机的运动和行为。标识符为目标电机的特定ID。数据以大端格式存储。

#### 4.1 力位混合控制模式

主要用于足式机器人等应用。

- **标识符**: 电机ID
- **数据帧 (8字节)**:
  | 位 | 字段 | 取值范围 | 对应物理值 |
  |----|------|----------|-----------|
  | 61-63 | 电机模式 | `0x00` | - |
  | 49-60 | KP | 0-4095 | 0.0f 到 500.0f |
  | 40-48 | KD | 0-511 | 0.0f 到 5.0f |
  | 24-39 | 位置 | 0-65536 | -12.5 到 12.5 rad |
  | 12-23 | 速度 | 0-4095 | -18.0 到 18.0 rad/s |
  | 0-11 | 力矩 | 0-4095 | -80 到 80 Nm |

#### 4.2 伺服位置控制模式

- **标识符**: 电机ID
- **数据帧 (8字节)**:
  | 位 | 字段 | 取值范围 | 详情 |
  |----|------|----------|------|
  | 61-63 | 电机模式 | `0x01` | - |
  | 29-60 | 位置 (float32) | - | 目标角度（度） |
  | 14-28 | 速度 (uint15) | 0-32767 | 对应 0-3276.7 rpm |
  | 2-13 | 电流 (uint12) | 0-4095 | 对应 0-409.5A |
  | 0-1 | ACK状态 | 0-3 | 反馈类型选择 |

#### 4.3 伺服速度控制模式

- **标识符**: 电机ID
- **数据帧 (7字节)**:
  | 位 | 字段 | 取值范围 | 详情 |
  |----|------|----------|------|
  | 53-55 | 电机模式 | `0x02` | - |
  | 48-49 | ACK状态 | 0-3 | 反馈类型选择 |
  | 16-47 | 速度 (float32) | - | 直接对应实际速度 (rpm) |
  | 0-15 | 电流 (uint16) | 0-65536 | 对应 0-6553.6A |

#### 4.4 电流/力矩控制和制动模式

- **标识符**: 电机ID
- **数据帧 (3字节)**:
  | 位 | 字段 | 取值范围 | 详情 |
  |----|------|----------|------|
  | 21-23 | 电机模式 | `0x03` | - |
  | 18-20 | 控制状态 | 0-7 | 见下表 |
  | 16-17 | ACK状态 | 0-3 | 反馈类型选择 |
  | 0-15 | 电流/力矩 | -32768 到 32767 | 电流或力矩值 |

**控制状态详情**:
- `0`: 普通电流控制
- `1`: 力矩控制模式
- `2`: 可变阻尼制动模式
- `3`: 能量耗散制动模式
- `4`: 再生制动模式

### 5. 问答模式反馈消息

电机使用其ID作为标识符回复。数据帧的第一个字节包含消息类型和错误状态。

- **字节0结构**:
  - **位5-7**: 消息类型 (1-5)
  - **位0-4**: 错误代码

**错误代码**:
- `0`: 无错误
- `1`: 电机过热
- `2`: 电机过流
- `3`: 电机电压过低
- `4`: 电机编码器错误
- `6`: 制动电压过高
- `7`: DRV驱动器错误

#### 反馈消息类型1 (8字节)
包含位置、速度、电流和温度信息。

#### 反馈消息类型2 (8字节)
包含位置（度）、电流和电机温度。

#### 反馈消息类型3 (8字节)
包含速度（rpm）、电流和电机温度。

## 电机控制原型开发指导方法

### 核心设计原则

1. **模块化 (Modularity)**: 将不同功能分离到独立模块
2. **抽象化 (Abstraction)**: 建立清晰的API层，隐藏底层复杂性
3. **可读性 (Readability)**: 编写清晰、有注释的代码

### 建议的原型架构

1. **硬件通信层**: 负责与USB-CAN分析仪硬件直接交互
2. **协议编码/解码层**: 按照CAN协议文档进行数据转换
3. **电机控制API层**: 提供面向对象的高级接口
4. **用户交互层**: 提供命令行界面进行交互

### 分步实现指南

1. **步骤一**: 搭建环境与基础通信
2. **步骤二**: 实现设置与查询指令
3. **步骤三**: 攻克复杂的控制指令编码
4. **步骤四**: 实现反馈报文的通用解析器
5. **步骤五**: 构建并完善CLI

### 关键实践与注意事项

- **数据端序**: 所有数据均为大端格式
- **安全第一**: 调试时务必固定电机，准备切断电源
- **心跳保护**: 连续控制时发送间隔不超过500ms
- **指令间隔**: 设置类指令之间至少延迟500ms
- **错误处理**: 正确解析和显示错误码

## 安装

```bash
# 克隆仓库
git clone <repository-url>
cd encos_sdk

# 安装依赖（Python示例）
pip install python-can
```

## 使用方法

### 基本使用示例

```python
# 初始化CAN通信
from encos_sdk import Motor, CANInterface

# 创建CAN接口
can_interface = CANInterface(baudrate=1000000)

# 创建电机实例
motor = Motor(motor_id=0x01, can_interface=can_interface)

# 设置零点
motor.set_zero_point()

# 控制位置
motor.set_servo_position(position_deg=90.0, speed_rpm=100, current_a=5.0)

# 获取状态
status = motor.get_status(feedback_type=1)
print(f"位置: {status.position} rad, 速度: {status.velocity} rad/s")
```

### CLI命令示例

```bash
# 扫描总线上的电机
python encos_cli.py scan

# 设置电机零点
python encos_cli.py zero 0x01

# 控制电机位置
python encos_cli.py pos 0x01 90.0 100 5.0

# 监控电机状态
python encos_cli.py monitor 0x01
```

## 贡献

欢迎贡献代码！请先阅读贡献指南。

1. Fork 本仓库
2. 创建特性分支 (`git checkout -b feature/AmazingFeature`)
3. 提交更改 (`git commit -m 'Add some AmazingFeature'`)
4. 推送到分支 (`git push origin feature/AmazingFeature`)
5. 打开 Pull Request

## 许可证

本项目基于 MIT 许可证开源。详情请参见 [LICENSE](LICENSE) 文件。
